name: Common Unit Tests

on:
  workflow_call:
    inputs:
      backend:
        required: true
        type: string
      subsets_json:
        required: true
        type: string
        description: JSON array of subsets to run
      image:
        required: true
        type: string
      runs_on:
        required: true
        type: string
      container_volumes:
        required: true
        type: string
      container_options:
        required: true
        type: string

jobs:
  unit_test:
    runs-on: ${{ fromJson(inputs.runs_on) }}
    strategy:
      fail-fast: false
      matrix:
        subset: ${{ fromJson(inputs.subsets_json) }}
    name: unit-${{ matrix.subset == './' && 'root' || matrix.subset }}
    container:
      image: ${{ inputs.image }}
      ports:
        - 80
      volumes: ${{ fromJson(inputs.container_volumes) }}
      options: ${{ inputs.container_options }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          ssh-strict: true
          ssh-user: git
          persist-credentials: true
          clean: true
          sparse-checkout-cone-mode: true
          fetch-tags: false
          show-progress: true
          lfs: false
          submodules: false
          set-safe-directory: true

      - name: Run unit tests
        id: unit_test
        shell: bash
        run: |
          set -euo pipefail
          cd /__w/FlagScale/FlagScale
          git config --global --add safe.directory /__w/FlagScale/FlagScale

          BACKEND='${{ inputs.backend }}'
          SUBSET='${{ matrix.subset }}'
          SHA='${{ github.sha }}'
          PROJECT_ROOT="/__w/FlagScale/FlagScale"

          echo "Running unit tests for subset: $SUBSET"
          echo "Backend: $BACKEND"
          echo "Project root: $PROJECT_ROOT"

          # Setup backend if needed
          if [ "$BACKEND" = "train_flagscale" ]; then
            echo "Setting up training backend dependencies..."
            source /root/miniconda3/bin/activate flagscale-train
            source "$PROJECT_ROOT/.github/workflows/scripts/retry_functions.sh"

            # For megatron unit tests
            mkdir -p /opt/data
            cp -r /home/gitlab-runner/data/Megatron-LM/* /opt/data/ || true
            cp -r /home/gitlab-runner/tokenizers/Megatron-LM/* /opt/data/ || true

            # Install megatron.core with retry
            COMMANDS=(
              "rm -rf ${GITHUB_WORKSPACE}/Megatron-LM-FL"
              "git clone https://github.com/flagos-ai/Megatron-LM-FL.git"
              "cd ${GITHUB_WORKSPACE}/Megatron-LM-FL && pip install --no-build-isolation . -vvv"
            )
            retry_commands 3 "${COMMANDS[@]}"

            # Ensure we're back in the project root
            cd "$PROJECT_ROOT"
          fi

          # Run tests for this subset
          "$PROJECT_ROOT/tests/scripts/unit_tests/test_subset.sh" --backend "$BACKEND" --subset "$SUBSET" --id "$SHA"
          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo "✅ Unit test passed for subset: $SUBSET"
          else
            echo "❌ Unit test failed for subset: $SUBSET (exit code: $exit_code)"
          fi

          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          exit $exit_code
        timeout-minutes: 90
