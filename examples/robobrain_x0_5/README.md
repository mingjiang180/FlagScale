## Installation

### Clone Repository

```sh
git clone https://github.com/FlagOpen/FlagScale.git
cd FlagScale/
```

### Setup Conda Environment

Create a new conda environment for robotics training:

```sh
conda create -n flagscale-train python=3.12
conda activate flagscale-train
```

Install FlagScale and robotics dependencies:

```sh
cd FlagScale/
pip install . --verbose
pip install -r requirements/train/robotics/requirements.txt
pip install git+https://github.com/NVIDIA/Megatron-Energon.git@ab40226
```

## Training

## Download Backbone Model

```sh
git lfs install

mkdir -p /models/Qwen/
cd /models/Qwen/
git clone https://huggingface.co/Qwen/Qwen2.5-VL-3B-Instruct
```

If you don't have access to the international internet, download from modelscope.

```sh
mkdir -p /models/
cd /models/
modelscope download --model Qwen/Qwen2.5-VL-3B-Instruct --local_dir Qwen/Qwen2.5-VL-3B-Instruct
```

### Prepare Dataset

FlagScale uses WebDataset format and Megatraon.Energon data loader, you need process your data first.

There is a dataset processed: [demo_0913_n2](https://gitee.com/hchnr/flag-scale/tree/robotics_dataset/demo_0913_n2/wds-1).

Download demo_0913_n2:

```sh
mkdir /tmp/datasets
cd /tmp/datasets
git clone https://gitee.com/hchnr/flag-scale.git
cd flag-scale
git checkout robotics_dataset
```

Move .jpg and .npy files from ./demo_0913_n2/deps to /:

```sh
mkdir -p /share/
cp -r ./demo_0913_n2/deps/* /
```

The directory structure of demo_0913_n2 is as follows:
- build_dep.sh: Copy .npy and .jpg files from production environment to ./deps
- demo_0913_n2.jsonl: Timesteps, including: task(str), images(.jpg), action(.npy), state(.npy)
- deps: .npy and .jpg files
- wds-2: Data in webdataset format (DP=2), generated by tools/datasets/vla/convert.py

If you need to make your own datasets, generate Data in webdataset format (DP=2) to ./demo_0913_n2/wds-2:

```sh
python tools/datasets/vla/convert.py \
    --dataset-root=./demo_0913_n2 \
    --output-root=./demo_0913_n2 \
    --json=demo_0913_n2.jsonl \
    --train-split 1 \
    --val-split 0 \
    --images-key=image \
    --videos-key=video \
    --vision-root='' \
    --shuffle-tars \
    --num-workers=1 \
    --max-samples-per-tar 100000 \
    --dp-size 2
```

### Edit Config

```sh
cd FlagScale/
vim examples/robobrain_x0_5/conf/train/libero_qwengroot.yaml
```
Change 3 fields:
- framework.qwenvl.base_vlm -> /models/Qwen/Qwen2.5-VL-3B-Instruct
- datasets.data_path -> /tmp/datasets/flag-scale/demo_0913_n2/wds-1
- (optional) checkpoint_dir: path to model checkpoint

### Start Training
```sh
cd FlagScale/
python run.py --config-path ./examples/robobrain_x0_5/conf --config-name train action=run
```


### Checkpoint Output

Checkpoint is not publish yet, we need the checkpoint(./outputs/libero_qwengroot/checkpoints/ckpt_out) generated for serving.

Directory structure:
```sh
|-- action_model.pt
|-- backbone
|   |-- added_tokens.json
|   |-- chat_template.jinja
|   |-- config.json
|   |-- generation_config.json
|   |-- merges.txt
|   |-- model-00001-of-00002.safetensors
|   |-- model-00002-of-00002.safetensors
|   |-- model.safetensors.index.json
|   |-- preprocessor_config.json
|   |-- special_tokens_map.json
|   |-- tokenizer.json
|   |-- tokenizer_config.json
|   |-- video_preprocessor_config.json
|   `-- vocab.json
`-- config.yaml
```

## Serving

### Edit Config

```sh
cd FlagScale/
vim examples/robobrain_x0_5/conf/serve/libero_qwengroot.yaml
```

Change 2 fields:
- engine_args.model -> outputs/libero_qwengroot/checkpoints/ckpt_out
- engine_args.framework.qwenvl.base_vlm -> outputs/libero_qwengroot/checkpoints/ckpt_out/backbone

### Run Serving

```sh
cd FlagScale/
python run.py --config-path ./examples/robobrain_x0_5/conf --config-name serve action=run
```

### Test Server with Client

Download test images:

```sh
cd FlagScale/
wget https://gitee.com/hchnr/flag-scale/raw/robotics_dataset/orbbec_0_latest.jpg
wget https://gitee.com/hchnr/flag-scale/raw/robotics_dataset/orbbec_1_latest.jpg
wget https://gitee.com/hchnr/flag-scale/raw/robotics_dataset/orbbec_2_latest.jpg
```

Run client:

```sh
python examples/robobrain_x0_5/client_libero.py  \
--host 127.0.0.1 \
--port 5001 \
--base-img orbbec_0_latest.jpg \
--left-wrist-img orbbec_1_latest.jpg \
--right-wrist-img orbbec_2_latest.jpg \
--num-steps 20
```
